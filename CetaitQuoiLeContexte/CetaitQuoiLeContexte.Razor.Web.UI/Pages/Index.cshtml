@page
@model IndexModel
@{
    ViewData["Title"] = "C'était quoi le contexte, déjà ? - Une pause bien méritée";
}


@if (Model.ContextList != null)
{
<div class="container">

    @foreach (var item in Model.ContextList)
    {
        <partial name="_ContextPartial.cshtml" model="item" />
    }

    @if (this.Model.IsPreviousExists)
    {
        <div class="row text-left">
            <a href="/page/@Model.PreviousPageIndex" class="btn btn-primary">< Précédent(s)</a>
        </div>
    }

    @if (this.Model.IsNextPageExists)
    {
        <div class="row text-right">
            <a href="/page/@Model.NextPageIndex" class="btn btn-primary">Suivant(s) ></a>
        </div>
    }
</div>
}

@section Scripts
{
<script type="text/javascript">
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/fr_FR/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    $(document).ready(function() {
        $(".publish-fb").click(function() {
            var $currentButton = $(this);

            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {
                    postContentOfContextOnWallFromMe($currentButton.data("content"),
                                                     $currentButton.data("url"));
                } else {
                    FB.login(function(response){
                        validFacebookIsConnected();
                    }, {scope: 'public_profile,email'});
               }
            });
        });
    });

    function postContentOfContextOnWallFromMe(content, url) {
        var data = {
            caption: "Une nouvelle phrase sans son contexte est arrivée ! Sauras-tu le retrouver ?",
            message: content,
            link: url
        };

        FB.api('/me/feed', 'post', data, onPostOnWallCallBack);
    }

    function onPostOnWallCallBack(response) {
        console.log(response);
    }

    function statusChangeCallback(response) {
        if (response.status === 'connected') {
          validFacebookIsConnected();
        } else {
          updateTitleSharedLinksUpToState(false);
        }
   }

    function updateTitleSharedLinksUpToState(connected) {
        var elements = document.getElementsByClassName('publish-fb');
        for(var i=0; i < elements.length; i ++) {
            elements[i].innerHTML = (!connected ? 'Se connecter et p' : 'P') + 'ublier sur Facebook';
        }
    }

    window.fbAsyncInit = function() {
        FB.init({
            appId      : '231690860973031',
            cookie     : true,  // enable cookies to allow the server to access
                                // the session
            xfbml      : true,  // parse social plugins on this page
            version    : 'v2.8' // use graph api version 2.8
        });
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
    }

    function checkLoginState(actionAfterVerifLogin) {
        FB.getLoginStatus(function(response) {
          actionAfterVerifLogin(response);
        });
   }

    function validFacebookIsConnected() {
        FB.api('/me', function(response) {
          updateTitleSharedLinksUpToState(true);

          $(document).ready(function() {

          });
        });
      }
</script>
}



